<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lab 02</title>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #ffffff; color: #111; }
    header { padding: 18px 18px; border-bottom: 1px solid #e6e6e6; background: #fafafa; }
    header a { color: #1f3c88; text-decoration: none; font-weight: bold; }
    header a:hover { text-decoration: underline; }
    main { max-width: 1000px; margin: 0 auto; padding: 18px; }
    h1 { margin: 0 0 6px 0; color: #1f3c88; font-size: 20px; }
    h2 { color: #1f3c88; }
    h3 { color: #1f3c88; }
    h4 { color: #1f3c88; margin-bottom: 8px; }
    hr { border: 0; border-top: 1px solid #e6e6e6; margin: 18px 0; }
    pre { background: #f6f8fa; border: 1px solid #e6e6e6; border-radius: 10px; padding: 12px; overflow: auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    ul, ol { padding-left: 22px; }
    .small { color: #555; font-size: 12px; }
    .note { border-left: 4px solid #1f3c88; background: #eef5ff; padding: 10px 12px; border-radius: 8px; }
    .warn { border-left: 4px solid #c0392b; background: #fff1f0; padding: 10px 12px; border-radius: 8px; }
    .toc { border: 1px solid #e6e6e6; background: #fcfcfc; border-radius: 10px; padding: 12px; }
    .toc ul { margin: 0; }
    a { color: #1f3c88; }
  </style>
</head>

<body>

<header>
  <a href="../../index.html">← Volver a la portada</a>
  <div class="small" style="margin-top:6px;">Ingeniería de Software III — Laboratorios</div>
</header>

<main>

  <h1>Lab 02</h1>
  <h2>Evolución del módulo Estudiantes: opciones A y B (robustez, paginación, errores, seeder, Swagger)</h2>

  <p>
    Partiendo del <strong>aplicativo base demo-academico</strong> (ya existe la entidad <code>Estudiante</code> y la BD H2 en memoria),
    vas a evolucionar la API para mejorar su calidad: <strong>paginación</strong>, <strong>manejo global de errores</strong>,
    <strong>sembrado de datos (Seeder con Faker)</strong> y <strong>pruebas por Swagger</strong>.
  </p>

  <div class="note">
    <strong>Punto de partida:</strong> ya existe el proyecto base con <code>pom.xml</code> y <code>application.yml</code>.
    Verifica que Swagger funciona en <code>/swagger-ui.html</code> y que tienes:
    <code>app.seed.enabled</code> y <code>app.seed.cantidad</code>.
  </div>

  <div class="warn" style="margin-top:10px;">
    <strong>Importante:</strong> En este laboratorio tienes <strong>DOS opciones de implementación</strong>:
    <strong>Opción A</strong> (DTO + ApiResponse + Handler) u <strong>Opción B</strong> (Entity directo + Excepciones propias + Handler de errores con Map).
    Debes escoger <strong>UNA</strong> y dejarla funcionando completa.
  </div>

  <hr />

  <div class="toc">
    <h3 style="margin-top:0;">Contenido</h3>
    <ul>
      <li><a href="#resultados">1) Resultados esperados</a></li>
      <li><a href="#config">2) Configuración requerida (pom.xml y application.yml)</a></li>
      <li><a href="#estructura-a">3) Opción A — Estructura esperada</a></li>
      <li><a href="#pasos-a">4) Opción A — Paso a paso con código</a></li>
      <li><a href="#estructura-b">5) Opción B — Estructura esperada</a></li>
      <li><a href="#pasos-b">6) Opción B — Paso a paso con código</a></li>
      <li><a href="#seeder">7) Seeder con Faker (para ambas opciones)</a></li>
      <li><a href="#pruebas">8) Pruebas en Swagger (para ambas opciones)</a></li>
      <li><a href="#entregable">9) Entregable</a></li>
      <li><a href="#checklist">Checklist final</a></li>
    </ul>
  </div>

  <hr />

  <section id="resultados">
    <h2>1) Resultados esperados</h2>
    <ul>
      <li>Regla de negocio aplicada: <strong>email único</strong> (no se permiten duplicados).</li>
      <li>Paginación funcional (usando <code>Pageable</code>).</li>
      <li>Manejo global de errores (validación + negocio + not found + error general).</li>
      <li>Seeder con Faker controlado por <code>app.seed.enabled</code> y <code>app.seed.cantidad</code>.</li>
      <li>Pruebas realizadas desde Swagger (<code>/swagger-ui.html</code>).</li>
      <li>El estudiante documenta cuál opción implementó (A o B).</li>
    </ul>
  </section>

  <hr />

  <section id="config">
    <h2>2) Configuración requerida (pom.xml y application.yml)</h2>

    <h3>2.1 pom.xml (Java 21 + Web + JPA + H2 + Validation + Swagger + Faker)</h3>
    <p>Verifica que el <code>pom.xml</code> contenga (como mínimo) estas dependencias:</p>

    <pre><code>&lt;!-- Web --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- JPA --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- H2 --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.h2database&lt;/groupId&gt;
  &lt;artifactId&gt;h2&lt;/artifactId&gt;
  &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;

&lt;!-- Validation --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-validation&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- Swagger / Springdoc --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.springdoc&lt;/groupId&gt;
  &lt;artifactId&gt;springdoc-openapi-starter-webmvc-ui&lt;/artifactId&gt;
  &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- Faker (Seeder) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;com.github.javafaker&lt;/groupId&gt;
  &lt;artifactId&gt;javafaker&lt;/artifactId&gt;
  &lt;version&gt;1.0.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>

    <h3>2.2 application.yml (H2 + Swagger + Seeder)</h3>
    <p>Archivo: <code>src/main/resources/application.yml</code></p>
    <pre><code>server:
  port: 8080
spring:
  datasource:
    url: jdbc:h2:mem:demoacademico;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
    defer-datasource-initialization: true
  sql:
    init:
      mode: always
  h2:
    console:
      enabled: true
      path: /h2-console

springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html

app:
  seed:
    enabled: true
    cantidad: 500</code></pre>

    <div class="note">
      <strong>URLs:</strong>
      <ul>
        <li>Swagger: <code>http://localhost:8080/swagger-ui.html</code></li>
        <li>H2 Console: <code>http://localhost:8080/h2-console</code> (JDBC: <code>jdbc:h2:mem:demoacademico</code>)</li>
      </ul>
    </div>
  </section>

  <hr />

  <!-- =========================================================
       OPCIÓN A
  ========================================================== -->

  <section id="estructura-a">
    <h2>3) Opción A — Estructura esperada (DTO + ApiResponse + Handler)</h2>

    <p>
      Esta opción busca una API más mantenible: el Controller no expone la entidad, usa DTOs,
      y estandariza respuestas con <code>ApiResponse</code>.
    </p>

    <pre>co.edu.demoacademico
├── api
│   ├── ApiResponse.java
│   └── ResponseBuilder.java
├── controller
│   ├── EstudianteController.java
│   └── GlobalExceptionHandler.java
├── dto
│   ├── EstudianteCreateDTO.java
│   ├── EstudianteUpdateDTO.java
│   └── EstudianteDTO.java
├── exception
│   ├── BusinessException.java
│   └── NotFoundException.java
├── handler
│   └── EstudianteHandler.java
├── model
│   └── Estudiante.java
├── repository
│   └── EstudianteRepository.java
└── service
    ├── EstudianteService.java
    └── EstudianteServiceImpl.java</pre>
  </section>

  <section id="pasos-a">
    <h2>4) Opción A — Paso a paso con código</h2>

    <h3>4.1 Paso A1 — Crear DTOs</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/dto/EstudianteCreateDTO.java</code></h4>
    <pre><code>package co.edu.demoacademico.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;

public class EstudianteCreateDTO {

    @NotBlank(message = "El nombre es obligatorio")
    private String nombre;

    @NotBlank(message = "El email es obligatorio")
    @Email(message = "Formato de email inválido")
    private String email;

    public EstudianteCreateDTO() {}

    public String getNombre() { return nombre; }
    public void setNombre(String nombre) { this.nombre = nombre; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/dto/EstudianteUpdateDTO.java</code></h4>
    <pre><code>package co.edu.demoacademico.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;

public class EstudianteUpdateDTO {

    @NotBlank(message = "El nombre es obligatorio")
    private String nombre;

    @NotBlank(message = "El email es obligatorio")
    @Email(message = "Formato de email inválido")
    private String email;

    public EstudianteUpdateDTO() {}

    public String getNombre() { return nombre; }
    public void setNombre(String nombre) { this.nombre = nombre; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/dto/EstudianteDTO.java</code></h4>
    <pre><code>package co.edu.demoacademico.dto;

public class EstudianteDTO {

    private Long id;
    private String nombre;
    private String email;

    public EstudianteDTO() {}

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getNombre() { return nombre; }
    public void setNombre(String nombre) { this.nombre = nombre; }

    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
}</code></pre>

    <hr />

    <h3>4.2 Paso A2 — ApiResponse y ResponseBuilder</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/api/ApiResponse.java</code></h4>
    <pre><code>package co.edu.demoacademico.api;

import java.time.Instant;

public class ApiResponse&lt;T&gt; {

    private boolean success;
    private String message;
    private T data;
    private Instant timestamp = Instant.now();

    public ApiResponse() {}

    public ApiResponse(boolean success, String message, T data) {
        this.success = success;
        this.message = message;
        this.data = data;
        this.timestamp = Instant.now();
    }

    public boolean isSuccess() { return success; }
    public void setSuccess(boolean success) { this.success = success; }

    public String getMessage() { return message; }
    public void setMessage(String message) { this.message = message; }

    public T getData() { return data; }
    public void setData(T data) { this.data = data; }

    public Instant getTimestamp() { return timestamp; }
    public void setTimestamp(Instant timestamp) { this.timestamp = timestamp; }
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/api/ResponseBuilder.java</code></h4>
    <pre><code>package co.edu.demoacademico.api;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

public class ResponseBuilder {

    private ResponseBuilder() {}

    public static &lt;T&gt; ResponseEntity&lt;ApiResponse&lt;T&gt;&gt; ok(String message, T data) {
        return ResponseEntity.ok(new ApiResponse&lt;&gt;(true, message, data));
    }

    public static &lt;T&gt; ResponseEntity&lt;ApiResponse&lt;T&gt;&gt; created(String message, T data) {
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(new ApiResponse&lt;&gt;(true, message, data));
    }

    public static ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; badRequest(String message) {
        return ResponseEntity.badRequest()
                .body(new ApiResponse&lt;&gt;(false, message, null));
    }

    public static ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; notFound(String message) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(new ApiResponse&lt;&gt;(false, message, null));
    }

    public static ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; internalError(String message) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ApiResponse&lt;&gt;(false, message, null));
    }
}</code></pre>

    <hr />

    <h3>4.3 Paso A3 — Excepciones (Business / NotFound)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/exception/BusinessException.java</code></h4>
    <pre><code>package co.edu.demoacademico.exception;

public class BusinessException extends RuntimeException {
    public BusinessException(String message) {
        super(message);
    }
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/exception/NotFoundException.java</code></h4>
    <pre><code>package co.edu.demoacademico.exception;

public class NotFoundException extends RuntimeException {
    public NotFoundException(String message) {
        super(message);
    }
}</code></pre>

    <hr />

    <h3>4.4 Paso A4 — GlobalExceptionHandler (ApiResponse)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/controller/GlobalExceptionHandler.java</code></h4>
    <pre><code>package co.edu.demoacademico.controller;

import co.edu.demoacademico.api.ApiResponse;
import co.edu.demoacademico.api.ResponseBuilder;
import co.edu.demoacademico.exception.BusinessException;
import co.edu.demoacademico.exception.NotFoundException;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(NotFoundException.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleNotFound(NotFoundException ex) {
        return ResponseBuilder.notFound(ex.getMessage());
    }

    @ExceptionHandler(BusinessException.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleBusiness(BusinessException ex) {
        return ResponseBuilder.badRequest(ex.getMessage());
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;ApiResponse&lt;Map&lt;String, String&gt;&gt;&gt; handleValidation(MethodArgumentNotValidException ex) {
        Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();
        ex.getBindingResult().getFieldErrors()
                .forEach(fe -&gt; errors.put(fe.getField(), fe.getDefaultMessage()));

        return ResponseEntity.badRequest()
                .body(new ApiResponse&lt;&gt;(false, "Validación fallida", errors));
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; handleGeneric(Exception ex) {
        return ResponseBuilder.internalError("Error inesperado");
    }
}</code></pre>

    <hr />

    <h3>4.5 Paso A5 — Repository (existsByEmail + existsByEmailAndIdNot)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/repository/EstudianteRepository.java</code></h4>
    <pre><code>package co.edu.demoacademico.repository;

import co.edu.demoacademico.model.Estudiante;
import org.springframework.data.jpa.repository.JpaRepository;

public interface EstudianteRepository extends JpaRepository&lt;Estudiante, Long&gt; {

    boolean existsByEmail(String email);

    boolean existsByEmailAndIdNot(String email, Long id);
}</code></pre>

    <hr />

    <h3>4.6 Paso A6 — Service (interfaz + implementación)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/service/EstudianteService.java</code></h4>
    <pre><code>package co.edu.demoacademico.service;

import co.edu.demoacademico.model.Estudiante;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;

public interface EstudianteService {

    Estudiante crear(Estudiante e);

    Estudiante obtenerPorId(Long id);

    Page&lt;Estudiante&gt; listar(Pageable pageable);

    Estudiante actualizar(Long id, Estudiante e);

    void eliminar(Long id);
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/service/EstudianteServiceImpl.java</code></h4>
    <pre><code>package co.edu.demoacademico.service;

import co.edu.demoacademico.exception.BusinessException;
import co.edu.demoacademico.exception.NotFoundException;
import co.edu.demoacademico.model.Estudiante;
import co.edu.demoacademico.repository.EstudianteRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@Transactional
public class EstudianteServiceImpl implements EstudianteService {

    private final EstudianteRepository repo;

    public EstudianteServiceImpl(EstudianteRepository repo) {
        this.repo = repo;
    }

    @Override
    public Estudiante crear(Estudiante e) {
        if (repo.existsByEmail(e.getEmail())) {
            throw new BusinessException("Ya existe un estudiante con ese email");
        }
        return repo.save(e);
    }

    @Override
    @Transactional(readOnly = true)
    public Estudiante obtenerPorId(Long id) {
        return repo.findById(id)
                .orElseThrow(() -&gt; new NotFoundException("Estudiante no encontrado: " + id));
    }

    @Override
    @Transactional(readOnly = true)
    public Page&lt;Estudiante&gt; listar(Pageable pageable) {
        return repo.findAll(pageable);
    }

    @Override
    public Estudiante actualizar(Long id, Estudiante e) {
        Estudiante actual = obtenerPorId(id);

        if (repo.existsByEmailAndIdNot(e.getEmail(), id)) {
            throw new BusinessException("El email ya lo usa otro estudiante");
        }

        actual.setNombre(e.getNombre());
        actual.setEmail(e.getEmail());
        return repo.save(actual);
    }

    @Override
    public void eliminar(Long id) {
        Estudiante actual = obtenerPorId(id);
        repo.delete(actual);
    }
}</code></pre>

    <hr />

    <h3>4.7 Paso A7 — Handler (DTO ↔ Entity)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/handler/EstudianteHandler.java</code></h4>
    <pre><code>package co.edu.demoacademico.handler;

import co.edu.demoacademico.dto.EstudianteCreateDTO;
import co.edu.demoacademico.dto.EstudianteDTO;
import co.edu.demoacademico.dto.EstudianteUpdateDTO;
import co.edu.demoacademico.model.Estudiante;
import co.edu.demoacademico.service.EstudianteService;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Component;

@Component
public class EstudianteHandler {

    private final EstudianteService service;

    public EstudianteHandler(EstudianteService service) {
        this.service = service;
    }

    public EstudianteDTO crear(EstudianteCreateDTO in) {
        Estudiante entity = new Estudiante();
        entity.setNombre(in.getNombre());
        entity.setEmail(in.getEmail());

        Estudiante saved = service.crear(entity);
        return toDto(saved);
    }

    public EstudianteDTO obtener(Long id) {
        return toDto(service.obtenerPorId(id));
    }

    public Page&lt;EstudianteDTO&gt; listar(Pageable pageable) {
        return service.listar(pageable).map(this::toDto);
    }

    public EstudianteDTO actualizar(Long id, EstudianteUpdateDTO in) {
        Estudiante entity = new Estudiante();
        entity.setNombre(in.getNombre());
        entity.setEmail(in.getEmail());

        Estudiante updated = service.actualizar(id, entity);
        return toDto(updated);
    }

    public void eliminar(Long id) {
        service.eliminar(id);
    }

    private EstudianteDTO toDto(Estudiante e) {
        EstudianteDTO dto = new EstudianteDTO();
        dto.setId(e.getId());
        dto.setNombre(e.getNombre());
        dto.setEmail(e.getEmail());
        return dto;
    }
}</code></pre>

    <hr />

    <h3>4.8 Paso A8 — Controller (ApiResponse + Pageable)</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/controller/EstudianteController.java</code></h4>
    <pre><code>package co.edu.demoacademico.controller;

import co.edu.demoacademico.api.ApiResponse;
import co.edu.demoacademico.api.ResponseBuilder;
import co.edu.demoacademico.dto.EstudianteCreateDTO;
import co.edu.demoacademico.dto.EstudianteDTO;
import co.edu.demoacademico.dto.EstudianteUpdateDTO;
import co.edu.demoacademico.handler.EstudianteHandler;
import jakarta.validation.Valid;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/estudiantes")
public class EstudianteController {

    private final EstudianteHandler handler;

    public EstudianteController(EstudianteHandler handler) {
        this.handler = handler;
    }

    @PostMapping
    public ResponseEntity&lt;ApiResponse&lt;EstudianteDTO&gt;&gt; crear(@Valid @RequestBody EstudianteCreateDTO in) {
        return ResponseBuilder.created("Estudiante creado", handler.crear(in));
    }

    @GetMapping("/{id}")
    public ResponseEntity&lt;ApiResponse&lt;EstudianteDTO&gt;&gt; obtener(@PathVariable Long id) {
        return ResponseBuilder.ok("OK", handler.obtener(id));
    }

    // Ejemplo: /api/estudiantes?page=0&amp;size=5&amp;sort=nombre,asc
    @GetMapping
    public ResponseEntity&lt;ApiResponse&lt;Page&lt;EstudianteDTO&gt;&gt;&gt; listar(Pageable pageable) {
        return ResponseBuilder.ok("OK", handler.listar(pageable));
    }

    @PutMapping("/{id}")
    public ResponseEntity&lt;ApiResponse&lt;EstudianteDTO&gt;&gt; actualizar(
            @PathVariable Long id,
            @Valid @RequestBody EstudianteUpdateDTO in
    ) {
        return ResponseBuilder.ok("Estudiante actualizado", handler.actualizar(id, in));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity&lt;ApiResponse&lt;Object&gt;&gt; eliminar(@PathVariable Long id) {
        handler.eliminar(id);
        return ResponseBuilder.ok("Estudiante eliminado", null);
    }
}</code></pre>
  </section>

  <hr />

  <!-- =========================================================
       OPCIÓN B
  ========================================================== -->

  <section id="estructura-b">
    <h2>5) Opción B — Estructura esperada (Entity directo + Excepciones propias + Handler Map)</h2>

    <p>
      Esta opción es más simple para laboratorio: el Controller usa la entidad directamente.
      El Service lanza excepciones propias y el <code>GlobalExceptionHandler</code> responde un JSON estándar usando <code>Map</code>.
    </p>

    <pre>co.edu.demoacademico
├── controller
│   ├── EstudianteController.java
│   └── GlobalExceptionHandler.java
├── model
│   └── Estudiante.java
├── repository
│   └── EstudianteRepository.java
└── service
    ├── EstudianteService.java
    ├── EmailDuplicadoException.java
    └── EstudianteNoEncontradoException.java</pre>
  </section>

  <section id="pasos-b">
    <h2>6) Opción B — Paso a paso con código</h2>

    <h3>6.1 Paso B1 — Excepciones propias</h3>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/service/EmailDuplicadoException.java</code></h4>
    <pre><code>package co.edu.demoacademico.service;

public class EmailDuplicadoException extends RuntimeException {
    public EmailDuplicadoException(String email) {
        super("Ya existe un estudiante con el email: " + email);
    }
}</code></pre>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/service/EstudianteNoEncontradoException.java</code></h4>
    <pre><code>package co.edu.demoacademico.service;

public class EstudianteNoEncontradoException extends RuntimeException {
    public EstudianteNoEncontradoException(String email) {
        super("No se encontró estudiante con el email: " + email);
    }
}</code></pre>

    <hr />

    <h3>6.2 Paso B2 — GlobalExceptionHandler (Map JSON)</h3>
    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/controller/GlobalExceptionHandler.java</code></h4>

    <pre><code>package co.edu.demoacademico.controller;

import co.edu.demoacademico.service.EmailDuplicadoException;
import co.edu.demoacademico.service.EstudianteNoEncontradoException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

import java.time.Instant;
import java.util.HashMap;
import java.util.Map;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(EmailDuplicadoException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleEmailDuplicado(EmailDuplicadoException ex) {
        return ResponseEntity.status(HttpStatus.CONFLICT).body(errorBody(HttpStatus.CONFLICT, ex.getMessage()));
    }

    @ExceptionHandler(EstudianteNoEncontradoException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleNoEncontrado(EstudianteNoEncontradoException ex) {
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(errorBody(HttpStatus.NOT_FOUND, ex.getMessage()));
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleValidacion(MethodArgumentNotValidException ex) {
        Map&lt;String, String&gt; fields = new HashMap&lt;&gt;();
        for (FieldError fe : ex.getBindingResult().getFieldErrors()) {
            fields.put(fe.getField(), fe.getDefaultMessage());
        }

        Map&lt;String, Object&gt; body = errorBody(HttpStatus.BAD_REQUEST, "Validación inválida");
        body.put("fields", fields);
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(body);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleGeneral(Exception ex) {
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(errorBody(HttpStatus.INTERNAL_SERVER_ERROR, "Error inesperado"));
    }

    private Map&lt;String, Object&gt; errorBody(HttpStatus status, String message) {
        Map&lt;String, Object&gt; body = new HashMap&lt;&gt;();
        body.put("timestamp", Instant.now().toString());
        body.put("status", status.value());
        body.put("error", status.getReasonPhrase());
        body.put("message", message);
        return body;
    }
}</code></pre>

    <hr />

    <h3>6.3 Paso B3 — Repository (existsByEmail + findByEmail)</h3>
    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/repository/EstudianteRepository.java</code></h4>

    <pre><code>package co.edu.demoacademico.repository;

import co.edu.demoacademico.model.Estudiante;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface EstudianteRepository extends JpaRepository&lt;Estudiante, Long&gt; {

    boolean existsByEmail(String email);

    Optional&lt;Estudiante&gt; findByEmail(String email);
}</code></pre>

    <hr />

    <h3>6.4 Paso B4 — Service (regla email único + Pageable + buscarPorEmail)</h3>
    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/service/EstudianteService.java</code></h4>

    <pre><code>package co.edu.demoacademico.service;

import co.edu.demoacademico.model.Estudiante;
import co.edu.demoacademico.repository.EstudianteRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class EstudianteService {

    private final EstudianteRepository repository;

    public EstudianteService(EstudianteRepository repository) {
        this.repository = repository;
    }

    public Estudiante crear(Estudiante estudiante) {
        if (repository.existsByEmail(estudiante.getEmail())) {
            throw new EmailDuplicadoException(estudiante.getEmail());
        }
        return repository.save(estudiante);
    }

    public List&lt;Estudiante&gt; listar() {
        return repository.findAll();
    }

    public Page&lt;Estudiante&gt; listar(Pageable pageable) {
        return repository.findAll(pageable);
    }

    public Estudiante buscarPorEmail(String email) {
        return repository.findByEmail(email)
                .orElseThrow(() -&gt; new EstudianteNoEncontradoException(email));
    }
}</code></pre>

    <hr />

    <h3>6.5 Paso B5 — Controller (crear, listar, paginar, buscar)</h3>
    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/controller/EstudianteController.java</code></h4>

    <pre><code>package co.edu.demoacademico.controller;

import co.edu.demoacademico.model.Estudiante;
import co.edu.demoacademico.service.EstudianteService;
import jakarta.validation.Valid;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/estudiantes")
public class EstudianteController {

    private final EstudianteService service;

    public EstudianteController(EstudianteService service) {
        this.service = service;
    }

    @PostMapping
    public Estudiante crear(@Valid @RequestBody Estudiante estudiante) {
        return service.crear(estudiante);
    }

    @GetMapping
    public List&lt;Estudiante&gt; listar() {
        return service.listar();
    }

    // Ejemplo: /api/estudiantes/pagina?page=0&amp;size=5&amp;sort=nombre,asc
    @GetMapping("/pagina")
    public Page&lt;Estudiante&gt; listarPaginado(Pageable pageable) {
        return service.listar(pageable);
    }

    // Ejemplo: /api/estudiantes/buscar?email=ana@demo.com
    @GetMapping("/buscar")
    public Estudiante buscarPorEmail(@RequestParam String email) {
        return service.buscarPorEmail(email);
    }
}</code></pre>
  </section>

  <hr />

  <!-- =========================================================
       SEEDER (PARA AMBAS)
  ========================================================== -->

  <section id="seeder">
    <h2>7) Seeder con Faker (para ambas opciones)</h2>

    <p>
      Crea un seeder que inserte estudiantes automáticamente cuando:
      <code>app.seed.enabled=true</code> y la tabla esté vacía.
      La cantidad se controla por <code>app.seed.cantidad</code>.
    </p>

    <h4>Archivo: <code>src/main/java/co/edu/demoacademico/config/DataSeeder.java</code></h4>
    <pre><code>package co.edu.demoacademico.config;

import co.edu.demoacademico.model.Estudiante;
import co.edu.demoacademico.repository.EstudianteRepository;
import com.github.javafaker.Faker;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Locale;

@Configuration
public class DataSeeder {

    @Value("${app.seed.enabled:true}")
    private boolean enabled;

    @Value("${app.seed.cantidad:100}")
    private int cantidad;

    @Bean
    CommandLineRunner seedEstudiantes(EstudianteRepository repo) {
        return args -> {
            if (!enabled) return;
            if (repo.count() > 0) return;

            Faker faker = new Faker(new Locale("es"));
            int creados = 0;

            while (creados < cantidad) {
                String nombre = faker.name().fullName();
                String email = ("est" + creados + "_" + faker.internet().emailAddress())
                        .toLowerCase()
                        .replace(" ", "")
                        .replace("..", ".");

                Estudiante e = new Estudiante();
                e.setNombre(nombre);
                e.setEmail(email);

                try {
                    repo.save(e);
                    creados++;
                } catch (Exception ex) {
                    // si el email es único y falla, reintenta
                }
            }
        };
    }
}</code></pre>

    <div class="note">
      <strong>Validación:</strong> al iniciar la app, entra a H2 Console y ejecuta
      <code>SELECT COUNT(*) FROM estudiante;</code> para comprobar que se insertaron registros.
    </div>
  </section>

  <hr />

  <section id="pruebas">
    <h2>8) Pruebas en Swagger (para ambas opciones)</h2>

    <h3>8.1 Abrir Swagger</h3>
    <pre>http://localhost:8080/swagger-ui.html</pre>

    <h3>8.2 Casos mínimos de prueba</h3>
    <ol>
      <li><strong>POST</strong> estudiante válido → respuesta exitosa</li>
      <li><strong>POST</strong> email inválido → 400 (validación)</li>
      <li><strong>POST</strong> email duplicado → error controlado (A: 400, B: 409)</li>
      <li><strong>GET</strong> paginado → 200</li>
      <li><strong>GET</strong> buscar por email inexistente → 404 (en B) / 404 (en A si agregas endpoint)</li>
    </ol>

    <h3>8.3 Ejemplo de paginación</h3>
    <pre>/api/estudiantes?page=0&amp;size=5&amp;sort=nombre,asc</pre>

    <h3>8.4 Ejemplo de paginación (Opción B)</h3>
    <pre>/api/estudiantes/pagina?page=0&amp;size=5&amp;sort=nombre,asc</pre>
  </section>

  <hr />

  <section id="entregable">
    <h2>9) Entregable</h2>
    <ul>
      <li>Código funcionando con la opción elegida (<strong>A</strong> o <strong>B</strong>).</li>
      <li>Captura o evidencia (texto) de 2 pruebas en Swagger:
        <ul>
          <li>Una prueba exitosa (creación o listado)</li>
          <li>Una prueba con error controlado (validación o email duplicado)</li>
        </ul>
      </li>
      <li>En el README o al final del laboratorio, escribe: <strong>“Implementé la opción A/B”</strong>.</li>
    </ul>
  </section>

  <hr />

  <section id="checklist">
    <h2>Checklist final</h2>
    <ul>
      <li>La regla de email único está aplicada.</li>
      <li>Existe paginación con Pageable.</li>
      <li>Existen respuestas de error controladas (no stacktrace).</li>
      <li>Seeder con Faker funcionando con <code>app.seed.*</code>.</li>
      <li>Pruebas hechas desde Swagger.</li>
      <li>Se documentó si se implementó la Opción A o B.</li>
    </ul>
  </section>

  <hr />

  <p class="small">
    Ingeniería de Software III — Laboratorio práctico (Lab 02).  
    Evolución del módulo Estudiantes con dos rutas de implementación.
  </p>

</main>

</body>
</html>